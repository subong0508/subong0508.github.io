<!DOCTYPE html>
<html>

  <head>
  
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        TeX: {
          equationNumbers: {
            autoNumber: "AMS"
          }
        },
        tex2jax: {
        inlineMath: [ ['$', '$'] ],
        displayMath: [ ['$$', '$$'] ],
        processEscapes: true,
      }
    });
    MathJax.Hub.Register.MessageHook("Math Processing Error",function (message) {
          alert("Math Processing Error: "+message[1]);
        });
    MathJax.Hub.Register.MessageHook("TeX Jax - parse error",function (message) {
          alert("Math Processing Error: "+message[1]);
        });
    </script>
    <script type="text/javascript" async
      src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
    
  
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Wasserstein GAN</title>
  <meta name="description" content="오늘 포스팅은 Wasserstein GAN에 대해 알아보겠습니다. 모두 아시다시피, GAN은 data의 distribution을 배우는 generative model에 해당합니다. 그렇다면 probability distribution, 즉 확률분포를 학습한다는 것은 정확히 무슨 뜻...">
  
  <meta name="author" content="Jung Jaeeun">
  <meta name="copyright" content="&copy; Jung Jaeeun 2021">
  

  <!-- External libraries -->
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/monokai_sublime.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/css/lightbox.css">

  <!-- Favicon and other icons (made with http://www.favicon-generator.org/) -->
  <link rel="shortcut icon" href="/assets/icons/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/assets/icons/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" sizes="57x57" href="/assets/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/assets/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/assets/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/assets/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/assets/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/assets/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/assets/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/assets/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/assets/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
  <link rel="manifest" href="/assets/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/assets/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  
  <!-- Facebook OGP cards -->
  <meta property="og:description" content="오늘 포스팅은 Wasserstein GAN에 대해 알아보겠습니다. 모두 아시다시피, GAN은 data의 distribution을 배우는 generative model에 해당합니다. 그렇다면 probability distribution, 즉 확률분포를 학습한다는 것은 정확히 무슨 뜻..." />
  <meta property="og:url" content="http://subong.github.io" />
  <meta property="og:site_name" content="Data Vision" />
  <meta property="og:title" content="Wasserstein GAN" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="http://subong.github.io/assets/logo.png" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:width" content="612" />
  <meta property="og:image:height" content="605" />
  

  
  <!-- Twitter: card tags -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Wasserstein GAN">
  <meta name="twitter:description" content="오늘 포스팅은 Wasserstein GAN에 대해 알아보겠습니다. 모두 아시다시피, GAN은 data의 distribution을 배우는 generative model에 해당합니다. 그렇다면 probability distribution, 즉 확률분포를 학습한다는 것은 정확히 무슨 뜻...">
  <meta name="twitter:image" content="http://subong.github.io/assets/logo.png">
  <meta name="twitter:url" content="http://subong.github.io">
  

  

  <!-- Site styles -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://subong.github.io/generative-models/2020/12/29/Wasserstein-GAN.html">
  <link rel="alternate" type="application/rss+xml" title="Data Vision" href="http://subong.github.io/feed.xml" />
</head>


  <body>

    <header class="navigation" role="banner">
  <div class="navigation-wrapper">
    <a href="/" class="logo">
      
      <img src="/assets/logo.png" alt="Data Vision">
      
    </a>
    <a href="javascript:void(0)" class="navigation-menu-button" id="js-mobile-menu">
      <i class="fa fa-bars"></i>
    </a>
    <nav role="navigation">
      <ul id="js-navigation-menu" class="navigation-menu show">
        
          
          <li class="nav-link"><a href="/about/">About</a>
          
        
          
        
          
        
          
        
          
          <li class="nav-link"><a href="/posts/">Posts</a>
          
        
          
        
          
        
      </ul>
    </nav>
  </div>
</header>


    <div class="page-content">
        <div class="post">

<div class="post-header-container " >
  <div class="scrim ">
    <header class="post-header">
      <h1 class="title">Wasserstein GAN</h1>
      <p class="info">by <strong>Jung Jaeeun</strong></p>
    </header>
  </div>
</div>

<div class="wrapper">

 <span class="page-divider">
  <span class="one"></span>
  <span class="two"></span>
</span>
 

<section class="post-meta">
  <div class="post-date">December 29, 2020</div>
  <div class="post-categories">
  in 
    
    <a href="/category/generative-models">Generative-models</a>
    
  
  </div>
</section>  

<article class="post-content">
  <p>오늘 포스팅은 Wasserstein GAN에 대해 알아보겠습니다. 
모두 아시다시피, GAN은 data의 distribution을 배우는 generative model에 해당합니다. 그렇다면 probability distribution, 즉 확률분포를 학습한다는 것은 정확히 무슨 뜻일까요? WGAN에 대해 알아보기 전에 보다 일반적인 얘기를 먼저 하고 넘어가려고 합니다.</p>

<p>parametric한 approach에서는 우리 데이터의 분포가 $P_{\theta} \text{ where }\theta \in \mathbb{R^{d}}$에 속한다고 가정하고 data의 likelihood를 최대화하는 방향으로 $\theta$를 추정합니다.</p>

<p>$\hat{\theta} = argmax_{\theta}\frac{1}{m}\sum_{i=1}^{m}\log P_{\theta}(x^{(i)})$</p>

<p>여기서 log는 단조 증가 함수이므로 위의 식이 성립합니다. asymptotic 하게 위의 식은 $KL(\mathbb{P_{r}} \vert\vert \mathbb{P_{\theta}})$를 최소화하는 것과 같습니다.</p>

<p>확률분포간의 거리를 재는 방법이 있다면 우리는 데이터를 통해 추정한 분포와 실제 분포와의 거리를 최소화하려고 할 것이고, KL divergence는 일반적으로 분포간의 거리/유사도를 측정하는데 가장 많이 쓰이는 metric이기 때문에 우리의 직관과 매우 일치합니다.</p>

<h2 id="different-distances">Different Distances</h2>

<p>그러나 확률분포간의 거리를 재는 방법이 KL divergence 하나만 있는 것은 아닙니다. 이 논문에서는 4가지 방법들에 대해 간단하게 소개를 해줍니다.</p>

<ul>
  <li>
    <p><em>Total Variation</em> distance: $\delta(\mathbb{P_{r}}, \mathbb{P_{g}}) = \sup_{A \in \sum} \vert \mathbb{P_{r}}(A)-\mathbb{P_{g}}(A) \vert$</p>
  </li>
  <li>
    <p><em>Kullback-Leibler</em> divergence: $KL(\mathbb{P_{r}} \vert\vert \mathbb{P_{g}}) = \int log\frac{P_{r}(x)}{P_{g}(x)}P_{r}(x)d\mu(x)$</p>
  </li>
  <li>
    <p><em>Jensen-Shannon</em> divergence: $JS(\mathbb{P_{r}} , \mathbb{P_{g}}) = KL(\mathbb{P_{r}} \vert\vert \mathbb{P_{m}})+KL(\mathbb{P_{g}} \vert\vert \mathbb{P_{m}})$</p>
  </li>
  <li>
    <p><em>Earth-Mover</em> distance: $W(\mathbb{P_{r}} , \mathbb{P_{g}}) = \inf_{\gamma \in \prod{(\mathbb{P_{r}} , \mathbb{P_{g}})}} \mathbb{E_{(x, y)\thicksim\gamma}}[\vert\vert x-y \vert\vert]$</p>
  </li>
</ul>

<p>논문에서 제시한 example을 한 번 살펴봅시다. $Z \thicksim U[0, 1]$인 확률변수라고 하고 $\mathbb{P_{0}}$을 $(0, Z)$의 분포, $\mathbb{P_{\theta}}$를 $(\theta, Z)$의 분포라고 합니다. 앞에서 소개한 여러 distance metric에 따르면 두 분포의 distance는 다음과 같습니다. 유도과정은 생략하겠습니다.</p>

<ul>
  <li>
    <p>$W(\mathbb{P_{0}} , \mathbb{P_{\theta}}) = \vert \theta \vert$</p>
  </li>
  <li>
    <p>$JS(\mathbb{P_{0}} , \mathbb{P_{\theta}}) = \log2 \text{ if } \theta \neq 0 \text{ else } 0$</p>
  </li>
  <li>
    <p>$KL(\mathbb{P_{0}} \vert\vert \mathbb{P_{\theta}}) = +\infty \text{ if } \theta \neq 0 \text{ else } 0$</p>
  </li>
  <li>
    <p>$\delta(\mathbb{P_{0}}, \mathbb{P_{\theta}}) = 1 \text{ if } \theta \neq 0 \text{ else } 0$</p>
  </li>
</ul>

<p><strong>이때, 여기서 흥미로운 점은 $\theta \in [-\infty, +\infty]$에서 연속인 함수는 EM distance 밖에 없다는 사실입니다.</strong> 그림으로 나타내면 아래와 같습니다.</p>

<p><img src="../../../../img/gans/wgan-dis.png" alt="new loss" /></p>

<p>왼편은 EM distance를 나타낸 것이고 오른편은 JS distance를 나타낸 그림입니다. 그러나 original GAN paper에서는 JS divergence를 기준으로 generator를 업데이트 해줍니다. 만약 그림과 같은 상황이 펼쳐진다면, gradient는 0이 되고 정상적인 학습이 이루어지지 않을 것입니다. 그에 비해 EM distance를 기준으로 generator를 학습한다면 원활한 학습이 이루어질 것입니다.</p>

<p><strong>결국, 이 논문의 essence는 NN으로 하여금 더 학습이 용이한 확률분포 distance metric을 정의하고 이를 기반으로 GAN을 학습시켰더니 더 잘 나왔다는 것입니다.</strong> 여기서 논문에 나와있는 Theorem 1,2를 보고 가겠습니다.</p>

<p><img src="../../../../img/gans/wgan-thrm1.png" alt="Theorem 1" /></p>

<p>1번은 우리가 estimate 하고자하는 parameter의 space가 continuous 하다면 $W(\mathbb{P_{r}}, \mathbb{P_{\theta}})$도 continuous 하다는 내용입니다. 2번은 mapping function $g$가 <em>locally Lipschitz</em>하고 regularity assumption 1을 만족한다면 $W(\mathbb{P_{r}}, \mathbb{P_{\theta}})$가 거의 모든 곳에서 미분가능하고, 이는 역전파를 가능하게 합니다. 3번에서는 1, 2가 $JS(\mathbb{P_{r}}, \mathbb{P_{\theta}}), KL(\mathbb{P_{r}}\vert\vert \mathbb{P_{\theta}})$에 대해서는 성립하지 않는다는 내용입니다.</p>

<p><strong>여기서 핵심은 $W(\mathbb{P_{r}}, \mathbb{P_{\theta}})$가 거의 모든 곳에서 미분가능하기 때문에 올바른 gradient를 전달한다는 것입니다.</strong> 그에 비해 $JS(\mathbb{P_{r}}, \mathbb{P_{\theta}}), KL(\mathbb{P_{r}}\vert\vert \mathbb{P_{\theta}})$는 그렇지 않아서 학습에 차질이 생깁니다. <em>locally Lipschitz</em> 하다는 것은 rough하게 말하자면 parameter space가 compact하고, 일정한 거리안에 모여있다는 뜻입니다. 이에 대해서는 뒤에서도 나옵니다. regularity asssumption은 확률분포에 대한 조건인데, 매우 loose한 조건이라 이를 만족하지 않는 확률분포를 찾아보기가 더 힘듭니다.</p>

<p><strong>따라서 우리는 EM distance를 기준으로 GAN을 학습시키면 되겠습니다.</strong></p>

<p><img src="../../../../img/gans/wgan-thrm2.png" alt="Theorem 2" /></p>

<p>1-4까지 읽어보시면, $W(\mathbb{P_{r}}, \mathbb{P_{\theta}}) \rightarrow 0$와 generator가 mapping 하는 분포가 데이터의 분포에 수렴하는 것이 동치임을 알 수 있습니다. 또한 KL, JS divergence 보다 EM distance가 weak한 개념이기 때문에 최적화가 보다 용이할 것이라고 기대할 수 있습니다. 논문에서는 이를 EM distance가 매우 sensible하다는 근거로 언급합니다.</p>

<h2 id="wasserstein-gan">Wasserstein GAN</h2>

<p>그러나 $W(\mathbb{P_{r}} , \mathbb{P_{g}}) = \inf_{\gamma \in \prod{(\mathbb{P_{r}} , \mathbb{P_{g}})}} \mathbb{E_{(x, y)\thicksim\gamma}}[\vert\vert x-y \vert\vert]$ 이 식을 직접적으로 다루기엔 문제가 있습니다. infimum(그냥 minimum으로 생각하시면 편합니다.) term이 intractible 하기 때문입니다. 그래서 우리는 Kantorovich-Rubinstein duality를 활용해서 다음과 같이 바꿔줍니다.</p>

<p>$W(\mathbb{P_{r}} , \mathbb{P_{g}}) = \sup_{\vert\vert f\vert\vert_{L \leq 1} } \mathbb{E_{x \thicksim P_{r}}}[f(x)] - \mathbb{E_{x \thicksim P_{\theta}}}[f(x)]$</p>

<p>이때, $\vert\vert f \vert\vert_{L \leq 1}$는 <em>locally Lipschitz</em>를 만족시키기 위한 조건입니다. 그러나 실제로는 이 조건이 NN의 flexibility를 제한하거나 gradient가 saturate 되는 등 여러 문제가 생기기 때문에 $\vert\vert f \vert\vert_{L \leq K}$를 사용했다고 합니다. 이는 gradient clipping을 통해서 쉽게 구현할 수 있습니다. 또한 식을 보면 우리가 기존에 학습시키는 NN과 크게 다르지 않은, tractible한 식이 됩니다.</p>

<p>어째됐든, 이제 우리의 문제는 $\max_{w \in \mathcal{W}} \mathbb{E_{x \thicksim P_{r}}}[f(x)] - \mathbb{E_{x \thicksim P_{\theta}}}[f(x)]$로 바뀌게 됩니다. $\mathcal{W}$는 앞서 말씀드린 $\vert\vert f \vert\vert_{L \leq K}$를 만족하는 공간입니다. 요약하면 다음과 같습니다.</p>

<p><img src="../../../../img/gans/wgan-thrm3.png" alt="Theorem 3" /></p>

<p>그러면 이제 기존 GAN과 마찬가지로 $W(\mathbb{P_{r}} , \mathbb{P_{g}})$에 대해 generator는 minimize, discriminator는 maximize를 하는 minimax problem을 풀면 됩니다. 수도코드는 매우 간단합니다.</p>

<p><img src="../../../../img/gans/wgan-pseudo.png" alt="Pseudo Code" /></p>

<p>여기서 설명드릴 점은 두 가지 입니다.</p>

<ol>
  <li>weight clipping을 통해 Lipschitz constraint를 구현했으나, 이건 좋은 방법이 아닙니다. weight의 norm을 제한한다면 gradient가 stuck 되는 현상이 나타날 수 있습니다. 또한 모멘텀을 사용하는 Adam optimizer를 사용했을때 오히려 역효과가 나기 때문에 비교적 학습이 오래 걸리는 RMSProp optimizer를 사용했습니다.</li>
  <li><strong>기존 GAN은 generator가 mapping을 제대로 못하는 상황에서 discriminator가 optimal 상태에 도달하기가 쉽고, 이는 gradient가 죽어버리는 결과를 가져옵니다. 그러나 WGAN에서는 discriminator가 optimal 상태에 도달하는 것이 generator에게도 도움이 됩니다.</strong> 이로 인해 mode collapse도 방지할 수 있다고 논문에서는 주장합니다.</li>
</ol>

<p>기존 GAN과 WGAN의 그라디언트를 나타내는 그림을 보겠습니다.</p>

<p><img src="../../../../img/gans/wgan-grads.png" alt="Gradients" /></p>

<p>기존 GAN과 다르게 WGAN에서는 그라디언트가 linear 하기 때문에 saturate 되지 않고, 의미있는 정보를 전달할 수 있습니다.</p>

<h2 id="empirical-results-meaningful-loss-metric">Empirical Results: Meaningful loss metric</h2>

<p>마지막으로 설명드릴 내용은 <strong>EM distance가 meaningful loss metric</strong>으로 사용될 수 있다는 점입니다. 그림으로 한 번 보겠습니다.</p>

<p><img src="../../../../img/gans/wgan-loss.png" alt="EM loss" /></p>

<p><img src="../../../../img/gans/js-loss.png" alt="JS loss" /></p>

<p>JS divergence 보다 EM distance가 우리 직관에 더 일치하는 결과를 보여주고 있습니다.</p>

<h2 id="conclusion">Conclusion</h2>

<p>이번 포스팅에서는 GAN의 loss metric을 개선한 Wasserstein GAN에 대해 알아보았습니다. 수학적인 내용이 많아 쉽지는 않지만 아이디어 자체는 심플한 논문입니다. 이를 더 개선한 <a href="https://arxiv.org/pdf/1704.00028.pdf">Improved Training of Wasserstein GANs</a> 논문이 있는데, 다음에 기회가 되면 다뤄보려고 합니다.</p>

<h2 id="references">References</h2>
<p><a href="https://arxiv.org/pdf/1701.07875.pdf">Wasserstein GAN</a></p>

</article>



<section class="tags">
  <strong>Tags:</strong> <a href="/tag/GAN">GAN</a>,&nbsp;<a href="/tag/WGAN">WGAN</a>,&nbsp;<a href="/tag/Wasserstein-GAN">Wasserstein-GAN</a>,&nbsp;<a href="/tag/deep-learning">deep-learning</a>
</section>



<section class="rss">
  <p class="rss-subscribe text"><strong>Subscribe <a href="/feed.xml">via RSS</a></strong></p>
</section>

<section class="share">
  <span>Share: </span>
  
    
    
    
    
    
    
    
  
</section>

	<section class="post-navigation">
		<span class="prev-post">
			
				<a href="/generative-models/2020/12/27/Improved-Techniques-for-Training-GANs.html">
					<span class="fa-stack fa-lg">
						<i class="fa fa-square fa-stack-2x"></i>
						<i class="fa fa-angle-double-left fa-stack-1x fa-inverse"></i>
					</span>
					<span class="page-number">Improved Techniques for Training GANs</span>
				</a>
			
		</span>
		<span class="next-post">
			
				<a href="/generative-models/2021/01/07/InfoGAN.html">
					<span class="page-number">InfoGAN</span>
					<span class="fa-stack fa-lg">
						<i class="fa fa-square fa-stack-2x"></i>
						<i class="fa fa-angle-double-right fa-stack-1x fa-inverse"></i>
					</span>
				</a>
			
		</span>
	</section>




</div>
</div>

    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h3 class="footer-heading">Data Vision</h3>

    <div class="site-navigation">
      
      <p><strong>Site Map</strong></p>
      <ul class="pages">
        
        
          <li class="nav-link"><a href="/about/">About</a>
        
        
        
        
        
        
        
        
        
          <li class="nav-link"><a href="/posts/">Posts</a>
        
        
        
        
        
        
      </ul>
    </div>

    <div class="site-contact">

      <p><strong>Contact</strong></p>
      <ul class="social-media-list">
        <li>
          <a href="mailto:subong0508@naver.com">
            <i class="fa fa-envelope-o"></i>
            <span class="username">subong0508@naver.com</span>
          </a>
        </li>

        
          
          <li>
            <a href="https://github.com/subong0508" title="Fork me on GitHub">
              <i class="fa fa-github"></i>
              <span class="username">subong0508</span>
            </a>
          </li>
          
        

      </ul>
    </div>

    <div class="site-signature">
      <p class="rss-subscribe text"><strong>Subscribe <a href="/feed.xml">via RSS</a></strong></p>
      <p class="text">My personal blog for studying AI
</p>
    </div>

  </div>

</footer>

<!-- Scripts -->
<script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/js/lightbox.min.js"></script>
<script>

$(document).ready(function() {

  // Syntax highlighting
  hljs.initHighlightingOnLoad();

  // Header
  var menuToggle = $('#js-mobile-menu').unbind();
  $('#js-navigation-menu').removeClass("show");
  menuToggle.on('click', function(e) {
    e.preventDefault();
    $('#js-navigation-menu').slideToggle(function(){
      if($('#js-navigation-menu').is(':hidden')) {
        $('#js-navigation-menu').removeAttr('style');
      }
    });
  });


});

</script>




  </body>

</html>
